# Runner Service Documentation

## Overview

The Runner Service is a core component of the ALT_LAS system responsible for executing ALT files, managing task execution, interacting with AI services, and generating LAST files containing execution results. It is implemented in Rust for performance, safety, and reliability.

## Architecture

The Runner Service consists of the following main components:

1.  **ALT File Processing (`alt_file`)**: Handles parsing, validation, and processing of ALT files.
2.  **Task Management (`task_manager`)**: Manages asynchronous task execution, dependencies, and scheduling.
3.  **AI Service Integration (`ai_service`)**: Communicates with AI services (like AI Orchestrator) for task execution.
4.  **LAST File Generation (`last_file`)**: Creates LAST files from execution results, including artifacts and reports.
5.  **FFI Layer (`ffi`)**: Provides a secure interface for other languages to interact with the Runner Service (details in existing README).

## ALT File Processing (`alt_file`)

The `alt_file` module handles the parsing and validation of ALT files. ALT files are JSON documents that define a series of tasks to be executed.

### Key Features:
- **Flexible Parsing**: Uses `serde_json` for robust JSON parsing.
- **`AltParser` Struct**: Provides a configurable parser (`with_schema`, `with_default_dir`, `with_strict_validation`).
- **Comprehensive Validation (`validator.rs`)**: 
    - Checks for empty fields (ID, title, version, task ID, description).
    - Detects duplicate task IDs.
    - Validates dependency existence and checks for self-dependencies.
    - Implements robust circular dependency detection using Depth-First Search (DFS).
    - Includes warnings for potentially problematic configurations (e.g., zero timeout, high retry count, isolated tasks).
    - Validates proposed execution sequences against dependencies.
- **Schema Validation**: Supports optional JSON schema validation (placeholder, requires external crate like `jsonschema`).
- **File Merging**: Provides functionality to merge multiple ALT files into one, handling potential task ID conflicts.
- **Error Handling**: Defines `AltParseError` enum for detailed error reporting.
- **Sample File Generation**: Includes `create_sample_alt_file` for testing.

## Task Management (`task_manager`)

The `task_manager` module is responsible for scheduling and executing tasks defined in ALT files asynchronously, respecting dependencies and concurrency limits.

### Key Features:
- **Asynchronous Execution**: Uses `tokio` for non-blocking task execution.
- **Dependency-Based Scheduling**: Ensures tasks run only after their dependencies are successfully completed.
- **Concurrency Control**: Limits the number of tasks running simultaneously (`max_concurrency`).
- **Status Tracking**: Maintains the status of each task (`Pending`, `Running`, `Completed`, `Failed`).
- **Communication Channel**: Uses `tokio::sync::mpsc` channels to communicate task completion/failure back to the main execution loop.
- **Robust Loop**: The main execution loop manages the task queue, spawns tasks, and processes results until all reachable tasks are finished.

## AI Service Integration (`ai_service`)

The `ai_service` module provides communication with external AI services for task execution.

### Key Features:
- **`AiServiceClient`**: An asynchronous HTTP client built using `reqwest`.
- **Configurable**: Supports setting base URL, API key, timeout, retries, model, temperature, etc. (`AiServiceConfig`).
- **Task Execution**: Implements `execute_task` method to send task details to the AI service.
- **Retry Logic**: Includes exponential backoff for retrying failed requests.
- **Error Handling**: Captures and reports errors from network requests and API responses.
- **API Endpoint (`/execute`)**: Provides an `actix-web` handler to receive ALT file execution requests via HTTP.
- **Request Handling**: Parses `ExecuteAltRequest` (containing ALT file path or content and optional AI parameters).
- **Dynamic Client Configuration**: Allows overriding default AI client settings per request.
- **Integration with Task Manager**: The `/execute` handler uses the `TaskManager` to run the ALT file tasks.
- **Response Generation**: Returns `ExecuteAltResponse` with details about the generated LAST file and execution summary.

## LAST File Generation (`last_file`)

The `last_file` module creates LAST files from execution results. LAST files contain the results of executing an ALT file, including task outputs, execution statistics, and artifacts.

### Key Features:
- **`LastFile` Struct**: Defines the structure for storing execution results, including metadata, task results, success rate, and timing.
- **`TaskResult` Struct**: Represents the outcome of a single task execution (status, output, error, timing, artifacts).
- **`Artifact` Struct**: Defines the structure for artifacts generated by tasks.
- **`LastFileGenerator`**: Manages the creation and saving of LAST files.
- **Comprehensive Result Tracking**: Stores detailed results for each executed task.
- **Success Rate Calculation**: Automatically calculates the overall success rate.
- **Execution Graph Visualization**: Generates a DOT file representing the task dependency graph and execution status. Attempts to create a PNG image using GraphViz (`dot` command) if available.
- **HTML Report Generation**: Creates a user-friendly HTML report summarizing the execution and detailing each task result and artifact.
- **Structured Output**: Saves the LAST file (`result.last`), HTML report (`report.html`), and graph (`<last_id>.png`, if generated) in a dedicated directory named after the LAST file ID.
- **Artifact Management (Placeholder)**: The `Artifact` struct is defined, but artifact generation/linking needs integration with actual task execution logic.

### LAST File Structure

A LAST file (`result.last`) contains the following information in JSON format:
- `id`: Unique ID for the LAST file.
- `alt_file_id`: ID of the source ALT file.
- `title`, `description`: Metadata about the execution.
- `execution_started`, `execution_completed`: Timestamps.
- `mode`, `persona`: Execution parameters from the ALT file.
- `task_results`: An array of `TaskResult` objects.
- `success_rate`: Overall success rate (0.0 to 1.0).
- `total_execution_time_ms`: Total duration of the execution.
- `execution_graph_path`: Relative path to the generated graph image (optional).
- `metadata`: Additional metadata.

## FFI Layer (`ffi`)

(Existing documentation for FFI remains valid - provides C and Python examples for interacting with the Runner Service.)

## Building and Testing

### Prerequisites
- Rust (check `rust-toolchain.toml` or project docs for specific version)
- Cargo
- GraphViz (`dot` command, optional, for execution graph visualization)

### Building
```bash
cargo build --release
```

### Testing
*Note: Automated tests require a properly configured Rust environment with Cargo.*
```bash
cargo test
```
*(If `cargo` is unavailable, manual code review and verification based on the implemented tests within the code (`#[cfg(test)]` blocks) are necessary.)*

### Building FFI Library
```bash
cargo build --release --features ffi
```

## Configuration

The Runner Service can be configured through environment variables or a configuration file (implementation details may vary).

- `RUNNER_LOG_LEVEL`: Log level (e.g., `trace`, `debug`, `info`, `warn`, `error`). Default: `info`.
- `RUNNER_MAX_CONCURRENT_TASKS`: Maximum number of tasks to run in parallel. Default: Number of CPU cores.
- `RUNNER_OUTPUT_DIR`: Default base directory for saving LAST file outputs. Default: `./output`.
- `RUNNER_AI_SERVICE_URL`: Base URL of the AI Orchestrator or compatible service. Default: `http://localhost:8000`.
- `RUNNER_AI_API_KEY`: Optional API key for the AI service.
- `RUNNER_AI_TIMEOUT_SECONDS`: Timeout for AI service requests. Default: `60`.
- `RUNNER_AI_MAX_RETRIES`: Maximum number of retries for failed AI requests. Default: `3`.
- `RUNNER_AI_DEFAULT_MODEL`: Default AI model to use if not specified in the request.
- `RUNNER_GENERATE_GRAPHS`: Enable execution graph generation (`true`/`false`). Default: `true`.
- `RUNNER_COMPRESS_ARTIFACTS`: Enable artifact compression (`true`/`false`). Default: `true` (feature may require additional implementation).

